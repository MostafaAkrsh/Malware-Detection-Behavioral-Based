from audioop import add
import csv
import psutil

def getListOfProcessSortedByMemory():
    '''
    Get list of running process sorted by Memory Usage
    '''
    listOfProcObjects = []
    # Iterate over the list
    for proc in psutil.process_iter():
       try:
           # Fetch process details as dict
           pinfo = proc.as_dict(attrs=['pid', 'name', 'username'])
           pinfo['rss'] = proc.memory_info().rss
           # Append dict to list
           listOfProcObjects.append(pinfo);
       except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
           pass
    # Sort list of dict by key vms i.e. memory usage
    listOfProcObjects = sorted(listOfProcObjects, key=lambda procObj: procObj['rss'], reverse=True)
    return listOfProcObjects

#Lists for save processes that have suspecious memory activity
sus_list = set()
black_list = set()
virus_list = set(line.strip() for line in open('virus_list'))

while True:
    #Get all processes runnting in the os
    listOfRunningProcess = getListOfProcessSortedByMemory()
    curr_sus_list = []
    current_processes = listOfRunningProcess
    #Add all the processes that use memory more than 200mbs
    for process in current_processes:
        if process.get('rss') > 200000000:
            sus_list.add(process.get('name'))
            curr_sus_list.append(process.get('name'))

    #If the process had 200mbs and now it's not then add this to black-list for more investigations
    for process in sus_list:
        if process not in curr_sus_list:
            black_list.add(process)

    #If the black-listed processes has more than 200mbs again then it's virus and must be killed and save it's name in virus-list file
    for process in black_list:
        if process in curr_sus_list:
            f = open('virus_list', 'a')
            f.write(process+'\n')
            virus_list.add(process)

    #Print the current virus list
    print(virus_list)

    #Search for name in all process and kill the virus
    for proc in psutil.process_iter():
    # check whether the process name matches
        if proc.name() in virus_list:
            proc.kill()